<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a1a">
    <title>üéØ NeuralHire</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{background:#0a0a1a;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom)}
        :root{--p:#00ff88;--d:#e94560;--w:#ffaa00;--i:#6666ff;--bg:#0a0a1a;--card:#16213e;--cl:#1a1a3e;--cd:#0d1b2a;--tm:#666;--br:#1a1a3e}
        .nav-bar{display:flex;justify-content:space-around;background:#111122;border-top:1px solid var(--br);position:fixed;bottom:0;left:0;right:0;z-index:1000;padding:6px 0;padding-bottom:max(6px,env(safe-area-inset-bottom))}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:4px 12px;cursor:pointer;color:var(--tm);font-size:10px;font-weight:600;border:none;background:none}
        .nav-item.active{color:var(--p)}
        .nav-item .ni{font-size:20px;margin-bottom:2px}
        .page{display:none;padding:12px;padding-bottom:80px;min-height:100vh}
        .page.active{display:block}
        .header{display:flex;justify-content:space-between;align-items:center;padding:8px 0 12px;border-bottom:1px solid var(--br);margin-bottom:12px}
        .logo{font-size:16px;font-weight:800;color:var(--p)}
        .sb{font-size:11px;padding:4px 12px;border-radius:20px;font-weight:700}
        .sb.listening{background:rgba(0,255,136,.12);color:var(--p);animation:pu 2s infinite}
        .sb.recording{background:rgba(233,69,96,.2);color:var(--d);animation:pu .6s infinite}
        .sb.transcribing{background:rgba(255,170,0,.12);color:var(--w);animation:pu .5s infinite}
        .sb.thinking{background:rgba(102,102,255,.12);color:var(--i);animation:pu .8s infinite}
        .sb.ready{background:rgba(0,255,136,.12);color:var(--p)}
        .sb.error{background:rgba(255,0,0,.12);color:#f44}
        .sb.waiting{background:rgba(255,170,0,.12);color:var(--w);animation:pu 1.5s infinite}
        @keyframes pu{0%,100%{opacity:1}50%{opacity:.4}}
        .card{border-radius:10px;padding:14px;margin-bottom:10px}
        .cl{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;margin-bottom:6px}
        .qc{background:linear-gradient(135deg,var(--cl),var(--card));border-left:4px solid var(--d)}
        .qc .cl{color:var(--d)}
        .qc .cc{color:#ff6b81;font-size:14px;line-height:1.5}
        .ac{background:linear-gradient(135deg,var(--cd),#1b2838);border-left:4px solid var(--p);min-height:220px}
        .ac .cl{color:var(--p)}
        .ac .cc{color:#fff;font-size:19px;line-height:1.7;white-space:pre-wrap;word-wrap:break-word}
        .ac .cc b,.ac .cc strong{color:var(--p);font-weight:700}
        .tb{display:inline-block;font-size:8px;padding:2px 6px;border-radius:4px;background:rgba(102,102,255,.15);color:var(--tm);text-transform:uppercase;margin-left:8px;font-weight:600}
        .stb{display:flex;justify-content:space-around;align-items:center;padding:8px 0;border-top:1px solid var(--br);margin-top:8px}
        .st{text-align:center}
        .sv{font-size:17px;font-weight:700;color:var(--p)}
        .sl{font-size:9px;color:var(--tm);margin-top:1px}
        .sd{width:1px;height:28px;background:var(--br)}
        .btn{display:flex;align-items:center;justify-content:center;padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;width:100%;gap:6px}
        .btn:active{transform:scale(.97);opacity:.9}
        .bp{background:var(--p);color:#0a0a1a}
        .bd{background:rgba(233,69,96,.25);color:var(--d)}
        .bs{background:rgba(102,102,255,.15);color:var(--i)}
        .bo{background:transparent;border:1px solid #333;color:#aaa}
        .bw{background:rgba(255,170,0,.15);color:var(--w)}
        .bsm{padding:8px 14px;font-size:12px;border-radius:8px}
        .br{display:flex;gap:8px;margin-top:8px}
        .br .btn{flex:1}
        .fc{position:fixed;top:12px;right:12px;display:flex;gap:4px;z-index:100}
        .fb{width:30px;height:30px;border-radius:50%;border:1px solid #333;background:var(--card);color:#fff;font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .ss{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px}
        .sst{font-size:13px;font-weight:700;color:var(--p);margin-bottom:10px}
        .il{font-size:11px;color:var(--tm);margin-bottom:4px;font-weight:600}
        .input{width:100%;padding:10px 12px;background:var(--cd);border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;font-family:inherit;margin-bottom:8px}
        .input:focus{outline:none;border-color:var(--p)}
        textarea.input{min-height:100px;resize:vertical;font-family:'SF Mono','Fira Code',monospace;font-size:12px;line-height:1.5}
        .ih{font-size:10px;color:var(--tm);margin-top:-4px;margin-bottom:8px}
        .ih a{color:var(--p)}
        .vc{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px 0;margin-top:4px}
        .vt{padding:6px 16px;border-radius:20px;border:none;font-size:12px;font-weight:600;cursor:pointer}
        .vt.off{background:rgba(102,102,255,.12);color:var(--i)}
        .vt.on{background:rgba(0,255,136,.15);color:var(--p);border:1px solid var(--p)}
        .spb{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.05);font-size:16px;cursor:pointer}
        .spd{color:var(--p);font-size:13px;font-weight:600;min-width:35px;text-align:center}
        .cc-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
        .chip{padding:6px 14px;border-radius:20px;border:1px solid #333;background:transparent;color:#aaa;font-size:12px;font-weight:600;cursor:pointer}
        .chip.active{border-color:var(--p);color:var(--p);background:rgba(0,255,136,.08)}
        .pi{width:100%;min-height:100px;padding:14px;background:var(--cd);border:1px solid #333;border-radius:10px;color:#fff;font-size:14px;font-family:inherit;resize:vertical;margin-bottom:10px}
        .pi:focus{outline:none;border-color:var(--p)}
        .fbc{background:var(--card);border-left:4px solid var(--p);border-radius:10px;padding:16px;margin-top:12px;white-space:pre-wrap;line-height:1.6;font-size:14px;color:#aaa}
        .pr{background:var(--card);border-radius:10px;padding:16px;margin-top:12px;white-space:pre-wrap;line-height:1.7;font-size:14px}
        .sr{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--br)}
        .si{flex:1}
        .sn{font-size:14px;font-weight:600}
        .sde{font-size:11px;color:var(--tm);margin-top:2px}
        .toggle{width:48px;height:26px;background:#333;border-radius:13px;position:relative;cursor:pointer;border:none}
        .toggle.on{background:var(--p)}
        .toggle::after{content:'';width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:transform .3s}
        .toggle.on::after{transform:translateX(22px)}
        .pt{font-size:22px;font-weight:800;color:var(--p);margin-bottom:4px}
        .ps{font-size:12px;color:var(--tm);margin-bottom:16px}
        .divider{border:none;border-top:1px solid var(--br);margin:16px 0}
        .hidden{display:none!important}
        .mt-8{margin-top:8px}
        .mb-12{margin-bottom:12px}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--p);color:#0a0a1a;padding:10px 24px;border-radius:10px;font-size:13px;font-weight:700;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none}
        .toast.show{opacity:1}
        .ld::after{content:'';animation:dots 1.5s steps(4) infinite}
        @keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}
        .ai{display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;font-size:11px;color:var(--tm)}
        .ai.active{color:var(--p)}
        .ado{width:8px;height:8px;border-radius:50%;background:#333}
        .ai.active .ado{background:var(--d);animation:pu 1s infinite}
        .provider-badge{font-size:9px;padding:2px 8px;border-radius:10px;background:rgba(0,255,136,.1);color:var(--p);margin-left:8px}
        .key-status{font-size:10px;margin-top:4px;padding:4px 8px;border-radius:4px;display:inline-block}
        .key-status.active{background:rgba(0,255,136,.1);color:var(--p)}
        .key-status.empty{background:rgba(255,170,0,.1);color:var(--w)}
        .mic-bar-wrap{display:inline-flex;align-items:center;gap:8px;padding:4px 12px;background:var(--cd);border-radius:8px}
        .mic-bar{width:100px;height:8px;background:#1a1a3e;border-radius:4px;overflow:hidden}
        .mic-bar-inner{width:0%;height:100%;background:var(--p);border-radius:4px;transition:width .1s}
    </style>
</head>
<body>

<div class="toast" id="toast">‚úÖ Saved!</div>
<div class="fc" id="fontControls"><button class="fb" onclick="NH.changeFontSize(-2)">A-</button><button class="fb" onclick="NH.changeFontSize(2)">A+</button></div>

<!-- ===== SETUP ===== -->
<div class="page active" id="pageSetup">
    <div class="header"><div class="logo">üéØ NeuralHire</div><span style="font-size:11px;color:var(--tm)">v3.2</span></div>
    <div style="text-align:center;margin:16px 0">
        <div style="font-size:48px;margin-bottom:8px">üéØ</div>
        <h1 style="font-size:24px;color:var(--p);margin-bottom:4px">NeuralHire</h1>
        <p style="color:var(--tm);font-size:13px">AI-Powered Interview Copilot</p>
    </div>
    <div class="ss">
        <div class="sst">üîë Step 1: API Keys (Add one or more ‚Äî all FREE)</div>
        <p style="font-size:11px;color:var(--tm);margin-bottom:12px">Add multiple keys for auto-fallback. If one hits rate limit, it switches automatically.</p>
        <div class="il">Google Gemini Key ‚≠ê</div>
        <input class="input" type="password" id="inputGeminiKey" placeholder="AIzaxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        <div class="ih">Get free: <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a> ‚Üí Google login ‚Üí Create</div>
        <div class="il">Groq Key ‚ö° (Best for audio ‚Äî 30 req/min)</div>
        <input class="input" type="password" id="inputGroqKey" placeholder="gsk_xxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        <div class="ih">Get free: <a href="https://console.groq.com" target="_blank">console.groq.com</a> ‚Üí API Keys ‚Üí Create</div>
        <div class="il">OpenRouter Key üåê</div>
        <input class="input" type="password" id="inputOpenRouterKey" placeholder="sk-or-xxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        <div class="ih">Get free: <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> ‚Üí Create Key</div>
    </div>
    <div class="ss">
        <div class="sst">üìÑ Step 2: Your Resume</div>
        <textarea class="input" id="inputResume" placeholder="Software Engineer, 5 years experience&#10;&#10;- Senior Dev at TechCorp&#10;  Led team of 5, reduced latency 40%&#10;  Serving 1M+ users&#10;&#10;Skills: Python, React, AWS, Docker"></textarea>
    </div>
    <div class="ss">
        <div class="sst">üíº Step 3: Target Job</div>
        <textarea class="input" id="inputJobDesc" placeholder="Senior Software Engineer at Google&#10;Python, distributed systems, 5+ years" style="min-height:80px"></textarea>
    </div>
    <button class="btn bp" onclick="NH.saveSetup()" style="font-size:16px;padding:14px">üöÄ Start Interview Mode</button>
    <p style="text-align:center;margin-top:12px;font-size:11px;color:var(--tm)">Add at least ONE key. More keys = never rate limited.</p>
</div>

<!-- ===== LIVE ===== -->
<div class="page" id="pageLive">
    <div class="header">
        <div class="logo">üéØ NeuralHire</div>
        <div><span class="provider-badge" id="activeProvider">--</span> <span class="sb listening" id="statusBadge">‚óè LISTENING</span></div>
    </div>
    <div class="card qc"><div class="cl">‚ùì INTERVIEWER ASKED <span class="tb" id="questionType"></span></div><div class="cc" id="questionText">Tap üé§ when interviewer asks a question</div></div>
    <div class="card ac"><div class="cl">‚úÖ YOUR ANSWER</div><div class="cc" id="answerText">Ready! Place phone behind monitor.

Tap üé§ below when interviewer speaks.
Or use ‚å®Ô∏è Type Question for fastest results.</div></div>
    <div class="vc">
        <button class="vt off" id="voiceToggle" onclick="NH.toggleVoice()">üîá Voice OFF</button>
        <button class="spb" onclick="NH.adjustSpeed(-0.1)">üêå</button>
        <span class="spd" id="speedDisplay">1.1x</span>
        <button class="spb" onclick="NH.adjustSpeed(0.1)">üêá</button>
    </div>
    <div class="stb">
        <div class="st"><div class="sv" id="statQuestions">0</div><div class="sl">Questions</div></div><div class="sd"></div>
        <div class="st"><div class="sv" id="statSpeed">-</div><div class="sl">Speed</div></div><div class="sd"></div>
        <div class="st"><div class="sv" id="statSession">0:00</div><div class="sl">Session</div></div>
    </div>

    <!-- Mic Level -->
    <div style="margin-top:8px;text-align:center">
        <div class="mic-bar-wrap">
            <span style="font-size:11px;color:var(--tm)">MIC:</span>
            <div class="mic-bar"><div class="mic-bar-inner" id="micLevelBar"></div></div>
            <span id="micStatus" style="font-size:10px;color:var(--tm)">--</span>
        </div>
    </div>

    <div class="br mt-8">
        <button class="btn bp" id="recordBtn" onclick="NH.toggleRecording()" style="flex:2">üé§ Tap to Listen</button>
        <button class="btn bd" onclick="NH.clearDisplay()" style="flex:1">üóë</button>
    </div>
    <div class="br" style="margin-top:6px">
        <button class="btn bo bsm" id="autoListenBtn" onclick="NH.toggleAutoListen()">üîÑ Auto: OFF</button>
        <button class="btn bs bsm" onclick="NH.manualInput()">‚å®Ô∏è Type Question</button>
        <button class="btn bw bsm" onclick="NH.testMic()">üé§ Test</button>
    </div>
    <div class="ai" id="autoIndicator"><div class="ado"></div><span>Auto-listen off</span></div>
</div>

<!-- ===== PRACTICE ===== -->
<div class="page" id="pagePractice">
    <div class="header"><div class="logo">üéØ Practice</div></div>
    <div class="pt">üéØ Practice Mode</div>
    <div class="ps">AI-powered interview practice with feedback</div>
    <div class="cc-chips">
        <button class="chip active" onclick="NH.selectCompany('general',this)">General</button>
        <button class="chip" onclick="NH.selectCompany('google',this)">Google</button>
        <button class="chip" onclick="NH.selectCompany('amazon',this)">Amazon</button>
        <button class="chip" onclick="NH.selectCompany('meta',this)">Meta</button>
        <button class="chip" onclick="NH.selectCompany('microsoft',this)">Microsoft</button>
        <button class="chip" onclick="NH.selectCompany('apple',this)">Apple</button>
        <button class="chip" onclick="NH.selectCompany('startup',this)">Startup</button>
    </div>
    <div class="card qc"><div class="cl">‚ùì PRACTICE QUESTION</div><div class="cc" id="practiceQuestion">Select company and tap "Next Question"!</div></div>
    <textarea class="pi" id="practiceAnswer" placeholder="Type your answer here..."></textarea>
    <div class="br">
        <button class="btn bp" onclick="NH.nextPracticeQuestion()">Next Question ‚ûú</button>
        <button class="btn bs" onclick="NH.evaluatePracticeAnswer()">ü§ñ Evaluate</button>
    </div>
    <button class="btn bo bsm mt-8" onclick="NH.showIdealAnswer()">üí° Show Ideal Answer</button>
    <div class="fbc hidden" id="practiceFeedback"></div>
    <hr class="divider" style="margin-top:24px">
    <div class="pt" style="font-size:18px">üìã Prep Sheet</div>
    <div class="br"><input class="input" id="prepCompany" placeholder="Company" style="margin:0;flex:1"><input class="input" id="prepRole" placeholder="Role" style="margin:0;flex:1"></div>
    <button class="btn bp mt-8" onclick="NH.generatePrepSheet()">üìã Generate</button>
    <div class="pr hidden" id="prepResult"></div>
</div>

<!-- ===== SETTINGS ===== -->
<div class="page" id="pageSettings">
    <div class="header"><div class="logo">‚öôÔ∏è Settings</div></div>
    <div class="pt">‚öôÔ∏è Settings</div>
    <div class="ss">
        <div class="sst">üîë API Keys</div>
        <div class="il">Gemini <span class="key-status empty" id="ksGemini">No key</span></div>
        <input class="input" type="password" id="settingsGeminiKey">
        <div class="il">Groq <span class="key-status empty" id="ksGroq">No key</span></div>
        <input class="input" type="password" id="settingsGroqKey">
        <div class="il">OpenRouter <span class="key-status empty" id="ksOR">No key</span></div>
        <input class="input" type="password" id="settingsORKey">
        <button class="btn bo bsm mt-8" onclick="NH.saveSettings()">üíæ Save</button>
        <button class="btn bs bsm mt-8" onclick="NH.testAllKeys()">üîå Test All</button>
    </div>
    <div class="ss">
        <div class="sst">üìÑ Resume</div>
        <textarea class="input" id="settingsResume" style="min-height:120px"></textarea>
        <button class="btn bo bsm" onclick="NH.saveSettings()">Save</button>
    </div>
    <div class="ss">
        <div class="sst">üíº Job Description</div>
        <textarea class="input" id="settingsJobDesc" style="min-height:80px"></textarea>
        <button class="btn bo bsm" onclick="NH.saveSettings()">Save</button>
    </div>
    <div class="ss">
        <div class="sst">üéõÔ∏è Features</div>
        <div class="sr"><div class="si"><div class="sn">üîä Voice Mode</div><div class="sde">Read through earphone</div></div><button class="toggle" onclick="NH.toggleSetting('voice',this)"></button></div>
        <div class="sr"><div class="si"><div class="sn">üì≥ Vibration</div><div class="sde">Vibrate on answer</div></div><button class="toggle on" onclick="NH.toggleSetting('vibration',this)"></button></div>
        <div class="sr"><div class="si"><div class="sn">‚òÄÔ∏è Keep Awake</div><div class="sde">Prevent sleep</div></div><button class="toggle on" onclick="NH.toggleSetting('wake',this)"></button></div>
    </div>
    <div class="ss">
        <div class="sst">üíæ Data</div>
        <button class="btn bo bsm mb-12" onclick="NH.exportData()">üì§ Export</button>
        <button class="btn bd bsm" onclick="NH.clearAllData()">üóë Clear All</button>
    </div>
</div>

<!-- NAV -->
<nav class="nav-bar" id="navBar">
    <button class="nav-item" onclick="NH.navigate('pageLive',this)" id="navLive"><span class="ni">üéØ</span>Live</button>
    <button class="nav-item" onclick="NH.navigate('pagePractice',this)"><span class="ni">üèãÔ∏è</span>Practice</button>
    <button class="nav-item" onclick="NH.navigate('pageSettings',this)"><span class="ni">‚öôÔ∏è</span>Settings</button>
</nav>

<script>
const NH={
    keys:{gemini:'',groq:'',openrouter:''},
    resume:'',jobDesc:'',conversationHistory:[],questionCount:0,sessionStart:null,fontSize:19,
    mediaRecorder:null,audioChunks:[],isRecording:false,audioStream:null,
    autoListening:false,autoListenTimer:null,recordTimeout:null,
    voiceEnabled:false,voiceSpeed:1.1,vibrationEnabled:true,
    selectedCompany:'general',currentPracticeQ:'',currentProvider:'',
    requestCounts:{gemini:0,groq:0,openrouter:0},
    lastRequestTimes:{gemini:0,groq:0,openrouter:0},
    audioContext:null,analyser:null,micMonitorInterval:null,

    questionBank:{
        general:["Tell me about yourself.","Why are you interested in this position?","What are your greatest strengths?","What is your biggest weakness?","Where do you see yourself in 5 years?","Tell me about a challenging project.","How do you handle conflict?","Why are you leaving your current job?","What makes you unique?","Do you have any questions for us?","Describe a time you showed leadership.","Tell me about a time you failed.","How do you handle pressure?","Why should we hire you?"],
        google:["Why Google?","Tell me about a time you dealt with ambiguity.","Describe your most impactful project.","How would you improve Google Search?","How do you handle disagreements?"],
        amazon:["Tell me about a time you took ownership.","Describe making a decision with incomplete data.","How do you ensure customer comes first?","Tell me about simplifying a complex process.","Tell me about disagreeing with your manager."],
        meta:["Why Meta?","How do you balance speed with quality?","Tell me about your most complex project.","How do you handle feedback?","Describe building something from 0 to 1."],
        microsoft:["Why Microsoft?","Give an example of growth mindset.","How would you improve a Microsoft product?","Describe a technical challenge you overcame."],
        apple:["Why Apple?","Tell me about a product you designed.","How do you balance UX with technical constraints?"],
        startup:["Why join a startup?","How do you handle wearing multiple hats?","Tell me about building from scratch.","How do you handle uncertainty?"]
    },

    // ===== INIT =====
    init(){this.loadSaved();this.setupTimer();this.requestWakeLock()},

    loadSaved(){
        this.keys.gemini=localStorage.getItem('nh_key_gemini')||'';
        this.keys.groq=localStorage.getItem('nh_key_groq')||'';
        this.keys.openrouter=localStorage.getItem('nh_key_openrouter')||'';
        this.resume=localStorage.getItem('nh_resume')||'';
        this.jobDesc=localStorage.getItem('nh_jobDesc')||'';
        this.voiceEnabled=localStorage.getItem('nh_voice')==='true';
        this.vibrationEnabled=localStorage.getItem('nh_vibration')!=='false';
        this.voiceSpeed=parseFloat(localStorage.getItem('nh_voiceSpeed')||'1.1');
        this.fontSize=parseInt(localStorage.getItem('nh_fontSize')||'19');

        document.getElementById('inputGeminiKey').value=this.keys.gemini;
        document.getElementById('inputGroqKey').value=this.keys.groq;
        document.getElementById('inputOpenRouterKey').value=this.keys.openrouter;
        if(this.resume)document.getElementById('inputResume').value=this.resume;
        if(this.jobDesc)document.getElementById('inputJobDesc').value=this.jobDesc;
        document.getElementById('settingsGeminiKey').value=this.keys.gemini;
        document.getElementById('settingsGroqKey').value=this.keys.groq;
        document.getElementById('settingsORKey').value=this.keys.openrouter;
        document.getElementById('settingsResume').value=this.resume;
        document.getElementById('settingsJobDesc').value=this.jobDesc;
        document.getElementById('speedDisplay').textContent=this.voiceSpeed.toFixed(1)+'x';
        this.updateKeyStatus();

        if(this.hasAnyKey()&&this.resume){
            this.navigate('pageLive',document.getElementById('navLive'));
            document.getElementById('navBar').classList.remove('hidden');
        }else{
            document.getElementById('navBar').classList.add('hidden');
            document.getElementById('fontControls').classList.add('hidden');
        }
    },

    hasAnyKey(){return!!(this.keys.gemini||this.keys.groq||this.keys.openrouter)},

    updateKeyStatus(){
        const u=(id,k)=>{const e=document.getElementById(id);if(e){e.textContent=k?'‚úÖ Active':'No key';e.className='key-status '+(k?'active':'empty')}};
        u('ksGemini',this.keys.gemini);u('ksGroq',this.keys.groq);u('ksOR',this.keys.openrouter);
    },

    // ===== SETUP =====
    saveSetup(){
        this.keys.gemini=document.getElementById('inputGeminiKey').value.trim();
        this.keys.groq=document.getElementById('inputGroqKey').value.trim();
        this.keys.openrouter=document.getElementById('inputOpenRouterKey').value.trim();
        this.resume=document.getElementById('inputResume').value.trim();
        this.jobDesc=document.getElementById('inputJobDesc').value.trim();
        if(!this.hasAnyKey()){alert('Enter at least ONE API key!\n\nEasiest: Google Gemini\naistudio.google.com/apikey');return}
        localStorage.setItem('nh_key_gemini',this.keys.gemini);
        localStorage.setItem('nh_key_groq',this.keys.groq);
        localStorage.setItem('nh_key_openrouter',this.keys.openrouter);
        localStorage.setItem('nh_resume',this.resume);
        localStorage.setItem('nh_jobDesc',this.jobDesc);
        document.getElementById('settingsGeminiKey').value=this.keys.gemini;
        document.getElementById('settingsGroqKey').value=this.keys.groq;
        document.getElementById('settingsORKey').value=this.keys.openrouter;
        document.getElementById('settingsResume').value=this.resume;
        document.getElementById('settingsJobDesc').value=this.jobDesc;
        this.updateKeyStatus();
        document.getElementById('navBar').classList.remove('hidden');
        document.getElementById('fontControls').classList.remove('hidden');
        this.navigate('pageLive',document.getElementById('navLive'));
        this.sessionStart=Date.now();
        this.requestMicrophone();
        const count=this.getActiveProviders().length;
        this.showToast('‚úÖ Ready! '+count+' provider'+(count>1?'s':'')+' active');
    },

    getActiveProviders(){
        const p=[];
        if(this.keys.groq)p.push('groq');
        if(this.keys.gemini)p.push('gemini');
        if(this.keys.openrouter)p.push('openrouter');
        return p;
    },

    // ===== NAV =====
    navigate(pageId,navItem){
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(navItem)navItem.classList.add('active');
        document.getElementById('fontControls').classList.toggle('hidden',pageId!=='pageLive');
    },

    // ===== MIC =====
    async requestMicrophone(){
        try{
            this.audioStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true,sampleRate:16000}});
            this.setStatus('listening','‚óè LISTENING');
            console.log('Mic ready');
        }catch(e){
            alert('Microphone access needed!\n\n'+e.message+'\n\nCheck browser settings and allow microphone for this site.');
            this.setStatus('error','‚óè MIC ERROR');
        }
    },

    // ===== MIC MONITOR =====
    startMicMonitor(){
        try{
            this.audioContext=new(window.AudioContext||window.webkitAudioContext)();
            this.analyser=this.audioContext.createAnalyser();
            this.analyser.fftSize=256;
            const source=this.audioContext.createMediaStreamSource(this.audioStream);
            source.connect(this.analyser);
            const data=new Uint8Array(this.analyser.frequencyBinCount);
            const bar=document.getElementById('micLevelBar');
            const st=document.getElementById('micStatus');
            this.micMonitorInterval=setInterval(()=>{
                this.analyser.getByteFrequencyData(data);
                const avg=data.reduce((a,b)=>a+b,0)/data.length;
                const pct=Math.min(100,avg*1.5);
                if(bar)bar.style.width=pct+'%';
                if(st){
                    if(pct>50){bar.style.background='var(--p)';st.textContent='üëç Good';st.style.color='var(--p)'}
                    else if(pct>15){bar.style.background='var(--w)';st.textContent='OK';st.style.color='var(--w)'}
                    else{bar.style.background='var(--d)';st.textContent='Quiet';st.style.color='var(--d)'}
                }
            },100);
        }catch(e){console.log('Monitor err:',e)}
    },

    stopMicMonitor(){
        clearInterval(this.micMonitorInterval);
        try{if(this.audioContext&&this.audioContext.state!=='closed')this.audioContext.close()}catch(e){}
        this.audioContext=null;
        const bar=document.getElementById('micLevelBar');
        const st=document.getElementById('micStatus');
        if(bar)bar.style.width='0%';
        if(st){st.textContent='--';st.style.color='var(--tm)'}
    },

    // ===== TEST MIC =====
    async testMic(){
        if(!this.audioStream){await this.requestMicrophone();if(!this.audioStream)return}
        this.showToast('üé§ Speak now! 3 sec test...');
        this.startMicMonitor();
        const chunks=[];
        const fmts=['audio/webm;codecs=opus','audio/webm','audio/mp4',''];
        let fmt='';for(const f of fmts){if(!f||(typeof MediaRecorder!=='undefined'&&MediaRecorder.isTypeSupported(f))){fmt=f;break}}
        let rec;try{rec=fmt?new MediaRecorder(this.audioStream,{mimeType:fmt}):new MediaRecorder(this.audioStream)}catch(e){rec=new MediaRecorder(this.audioStream)}
        rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data)};
        rec.start(100);
        await this.sleep(3000);
        rec.stop();this.stopMicMonitor();
        await this.sleep(500);
        const blob=new Blob(chunks,{type:rec.mimeType||'audio/webm'});
        let msg='üé§ Mic Test Results:\n\n';
        msg+='Format: '+(rec.mimeType||'unknown')+'\n';
        msg+='Size: '+blob.size+' bytes ('+(blob.size/1024).toFixed(1)+' KB)\n\n';
        if(blob.size<500){msg+='‚ùå No audio captured!\n\n‚Ä¢ Check browser mic permission\n‚Ä¢ Close other apps using mic\n‚Ä¢ Try different browser'}
        else if(blob.size<2000){msg+='‚ö†Ô∏è Very quiet audio\n\n‚Ä¢ Speak louder\n‚Ä¢ Move phone closer\n‚Ä¢ Turn up computer volume'}
        else{
            msg+='‚úÖ Audio captured OK!\n\nTesting transcription...\n';
            try{
                const text=await this.transcribeAudio(blob);
                if(text&&text.length>2)msg+='\n‚úÖ Transcription works!\nHeard: "'+text+'"';
                else msg+='\n‚ö†Ô∏è No speech detected.\nSpeak louder or closer next time.';
            }catch(e){msg+='\n‚ùå Transcription error: '+e.message+'\n\nYou can always use ‚å®Ô∏è Type Question instead!'}
        }
        alert(msg);
    },

    // ===== RECORDING =====
    toggleRecording(){this.isRecording?this.stopRecording():this.startRecording()},

    async startRecording(){
        if(!this.audioStream){await this.requestMicrophone();if(!this.audioStream)return}
        this.startMicMonitor();
        this.audioChunks=[];
        const fmts=['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/ogg;codecs=opus',''];
        let fmt='';for(const f of fmts){if(!f||(typeof MediaRecorder!=='undefined'&&MediaRecorder.isTypeSupported(f))){fmt=f;break}}
        try{this.mediaRecorder=fmt?new MediaRecorder(this.audioStream,{mimeType:fmt}):new MediaRecorder(this.audioStream)}catch(e){this.mediaRecorder=new MediaRecorder(this.audioStream)}
        console.log('Rec format:',this.mediaRecorder.mimeType);
        this.mediaRecorder.ondataavailable=e=>{if(e.data.size>0)this.audioChunks.push(e.data)};
        this.mediaRecorder.onstop=()=>{
            this.stopMicMonitor();
            const blob=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType||'audio/webm'});
            console.log('Blob:',blob.size,'bytes',blob.type);
            if(blob.size<1000){
                document.getElementById('answerText').textContent='üîá No audio detected.\n\n‚Ä¢ Speak louder\n‚Ä¢ Phone closer to speaker\n‚Ä¢ Try üé§ Test button\n‚Ä¢ Or use ‚å®Ô∏è Type Question';
                this.setStatus('listening','‚óè LISTENING');return;
            }
            this.processAudio(blob);
        };
        this.mediaRecorder.start(100);this.isRecording=true;
        const btn=document.getElementById('recordBtn');btn.textContent='‚èπ Tap to Stop';btn.style.background='var(--d)';btn.style.color='#fff';
        this.setStatus('recording','üî¥ RECORDING');
        this.recordTimeout=setTimeout(()=>{if(this.isRecording)this.stopRecording()},30000);
    },

    stopRecording(){
        clearTimeout(this.recordTimeout);this.stopMicMonitor();
        if(this.mediaRecorder&&this.mediaRecorder.state!=='inactive')this.mediaRecorder.stop();
        this.isRecording=false;
        const btn=document.getElementById('recordBtn');btn.textContent='üé§ Tap to Listen';btn.style.background='var(--p)';btn.style.color='#0a0a1a';
    },

    // ===== AUTO LISTEN =====
    toggleAutoListen(){
        this.autoListening=!this.autoListening;
        const btn=document.getElementById('autoListenBtn'),ind=document.getElementById('autoIndicator');
        if(this.autoListening){btn.textContent='üîÑ Auto: ON';btn.style.borderColor='var(--p)';btn.style.color='var(--p)';ind.classList.add('active');ind.querySelector('span').textContent='Auto-listening';this.autoListenLoop()}
        else{btn.textContent='üîÑ Auto: OFF';btn.style.borderColor='#333';btn.style.color='#aaa';ind.classList.remove('active');ind.querySelector('span').textContent='Auto-listen off';clearTimeout(this.autoListenTimer)}
    },

    async autoListenLoop(){
        if(!this.autoListening)return;
        await this.startRecording();
        this.autoListenTimer=setTimeout(()=>{if(this.isRecording)this.stopRecording();this.autoListenTimer=setTimeout(()=>{if(this.autoListening)this.autoListenLoop()},5000)},10000);
    },

    // ===== BASE64 =====
    blobToBase64(blob){
        return new Promise((resolve,reject)=>{
            const reader=new FileReader();
            reader.onloadend=()=>resolve(reader.result.split(',')[1]);
            reader.onerror=reject;
            reader.readAsDataURL(blob);
        });
    },

    // ===== HELPERS =====
    sleep(ms){return new Promise(r=>setTimeout(r,ms))},

    isRateLimited(p){
        const now=Date.now();
        if(now-this.lastRequestTimes[p]>60000){this.requestCounts[p]=0;return false}
        const limits={gemini:13,groq:25,openrouter:15};
        return this.requestCounts[p]>=(limits[p]||10);
    },

    trackRequest(p){
        const now=Date.now();
        if(now-this.lastRequestTimes[p]>60000)this.requestCounts[p]=0;
        this.requestCounts[p]++;this.lastRequestTimes[p]=now;
    },

    // ===== TRANSCRIPTION =====
    async transcribeAudio(audioBlob){
        // Try Groq Whisper first (best for audio)
        if(this.keys.groq&&!this.isRateLimited('groq')){
            try{
                console.log('Trying Groq Whisper...');
                this.trackRequest('groq');
                const fd=new FormData();
                fd.append('file',audioBlob,'recording.webm');
                fd.append('model','whisper-large-v3');
                fd.append('language','en');
                const r=await fetch('https://api.groq.com/openai/v1/audio/transcriptions',{
                    method:'POST',headers:{'Authorization':'Bearer '+this.keys.groq},body:fd
                });
                if(r.ok){const d=await r.json();const t=(d.text||'').trim();console.log('Groq:',t);if(t.length>2)return t}
                else console.log('Groq status:',r.status);
            }catch(e){console.log('Groq err:',e.message)}
        }

        // Try Gemini
        if(this.keys.gemini&&!this.isRateLimited('gemini')){
            const models=['gemini-1.5-flash','gemini-2.0-flash','gemini-1.5-flash-8b'];
            for(const model of models){
                try{
                    console.log('Trying '+model+'...');
                    this.trackRequest('gemini');
                    const b64=await this.blobToBase64(audioBlob);
                    const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+this.keys.gemini,{
                        method:'POST',headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({
                            contents:[{parts:[
                                {text:"Listen carefully to this audio and transcribe exactly what is being said. Return ONLY the spoken words as plain text. If you hear no speech at all, respond with just the word EMPTY."},
                                {inline_data:{mime_type:audioBlob.type||'audio/webm',data:b64}}
                            ]}],
                            generationConfig:{temperature:0.1,maxOutputTokens:300}
                        })
                    });
                    if(r.ok){
                        const d=await r.json();
                        let t=(d.candidates?.[0]?.content?.parts?.[0]?.text||'').trim();
                        t=t.replace(/^["']|["']$/g,'').trim();
                        console.log(model+':',t);
                        if(t&&t.length>2&&t!=='EMPTY'&&!t.toLowerCase().includes('no speech')&&!t.toLowerCase().includes('cannot hear')&&!t.toLowerCase().includes('no audio')&&!t.toLowerCase().includes('silence'))return t;
                    }else{
                        if(r.status===429){console.log(model+' rate limited');continue}
                        console.log(model+' status:',r.status);
                    }
                }catch(e){console.log(model+' err:',e.message);continue}
            }
        }

        return '';
    },

    // ===== PROCESS AUDIO =====
    async processAudio(audioBlob){
        const startTime=Date.now();
        try{
            this.setStatus('transcribing','‚óè TRANSCRIBING');
            document.getElementById('answerText').innerHTML='üîÑ Transcribing audio...';

            const question=await this.transcribeAudio(audioBlob);

            if(!question||question.length<3){
                document.getElementById('answerText').innerHTML='üîá No speech detected.\n\n‚Ä¢ Speak louder and closer to phone\n‚Ä¢ Try üé§ Test button to check mic\n‚Ä¢ Or use ‚å®Ô∏è Type Question\n\nReady to listen again.';
                this.setStatus('listening','‚óè LISTENING');return;
            }

            const noise=['thank you','thanks','okay','ok','um','uh','hmm','mhm','ah','right','sure','yes','no','you know','empty'];
            if(noise.includes(question.toLowerCase().trim())){this.setStatus('listening','‚óè LISTENING');return}

            const qType=this.classifyQuestion(question);
            document.getElementById('questionText').textContent=question;
            document.getElementById('questionType').textContent=qType;
            document.getElementById('answerText').innerHTML='<span class="ld">‚è≥ Generating answer</span>';
            this.setStatus('thinking','‚óè THINKING');

            const answer=await this.generateAnswer(question,qType);
            const rt=(Date.now()-startTime)/1000;this.questionCount++;
            this.displayAnswer(answer);
            document.getElementById('statQuestions').textContent=this.questionCount;
            document.getElementById('statSpeed').textContent=rt.toFixed(1)+'s';
            this.setStatus('ready','‚óè READY');
            if(this.vibrationEnabled&&navigator.vibrate)navigator.vibrate([100,50,100]);
            if(this.voiceEnabled)this.speakAnswer(answer);
        }catch(e){
            console.error(e);
            document.getElementById('answerText').textContent='‚ùå '+e.message+'\n\n‚Ä¢ Use ‚å®Ô∏è Type Question\n‚Ä¢ Check API keys in Settings\n‚Ä¢ Add more providers for fallback';
            this.setStatus('error','‚óè ERROR');
            setTimeout(()=>this.setStatus('listening','‚óè LISTENING'),3000);
        }
    },

    // ===== AI PROVIDERS =====
    async callGemini(prompt,model){
        model=model||'gemini-1.5-flash-8b';
        this.trackRequest('gemini');
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+this.keys.gemini,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:500}})
        });
        if(r.status===429)throw new Error('RATE_LIMIT');
        if(!r.ok)throw new Error('Gemini '+r.status);
        const d=await r.json();return d.candidates?.[0]?.content?.parts?.[0]?.text||'';
    },

    async callGroq(prompt){
        this.trackRequest('groq');
        const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
            method:'POST',headers:{'Authorization':'Bearer '+this.keys.groq,'Content-Type':'application/json'},
            body:JSON.stringify({model:'llama-3.1-8b-instant',messages:[{role:'user',content:prompt}],temperature:0.7,max_tokens:500})
        });
        if(r.status===429)throw new Error('RATE_LIMIT');
        if(!r.ok)throw new Error('Groq '+r.status);
        const d=await r.json();return d.choices[0].message.content;
    },

    async callOpenRouter(prompt){
        this.trackRequest('openrouter');
        const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{
            method:'POST',headers:{'Authorization':'Bearer '+this.keys.openrouter,'Content-Type':'application/json','HTTP-Referer':location.href},
            body:JSON.stringify({model:'meta-llama/llama-3.1-8b-instruct:free',messages:[{role:'user',content:prompt}],temperature:0.7,max_tokens:500})
        });
        if(r.status===429)throw new Error('RATE_LIMIT');
        if(!r.ok)throw new Error('OpenRouter '+r.status);
        const d=await r.json();return d.choices[0].message.content;
    },

    async callAI(prompt){
        const providers=this.getActiveProviders();
        if(!providers.length)throw new Error('No API keys! Go to Settings.');
        const sorted=providers.filter(p=>!this.isRateLimited(p)).concat(providers.filter(p=>this.isRateLimited(p)));
        let lastErr='';

        for(const p of sorted){
            try{
                this.currentProvider=p;
                document.getElementById('activeProvider').textContent=p;
                if(p==='gemini'){
                    try{return await this.callGemini(prompt,'gemini-1.5-flash-8b')}
                    catch(e){if(e.message==='RATE_LIMIT'){try{return await this.callGemini(prompt,'gemini-2.0-flash')}catch(e2){throw e2}}throw e}
                }
                if(p==='groq')return await this.callGroq(prompt);
                if(p==='openrouter')return await this.callOpenRouter(prompt);
            }catch(e){
                lastErr=e.message;
                if(e.message==='RATE_LIMIT'){console.log(p+' rate limited');continue}
                console.log(p+' error:',e.message);continue;
            }
        }

        if(lastErr==='RATE_LIMIT'){
            this.setStatus('waiting','‚è≥ WAITING');
            document.getElementById('answerText').innerHTML='‚è≥ Rate limited. Waiting 15s...';
            await this.sleep(15000);
            for(const p of providers){
                try{
                    if(p==='gemini')return await this.callGemini(prompt);
                    if(p==='groq')return await this.callGroq(prompt);
                    if(p==='openrouter')return await this.callOpenRouter(prompt);
                }catch(e){continue}
            }
        }

        throw new Error('All providers failed. '+lastErr+'\n\nAdd more API keys in Settings.');
    },

    // ===== GENERATE ANSWER =====
    async generateAnswer(question,qType){
        this.conversationHistory.push('Q: '+question);
        const hist=this.conversationHistory.slice(-8).join('\n');
        let sp;
        if(qType==='behavioral')sp='Expert interview coach. LIVE interview.\nRESUME:\n'+this.resume.substring(0,2500)+'\nJOB:\n'+this.jobDesc.substring(0,1000)+'\nHISTORY:\n'+hist+'\nRULES: First person. STAR: **Situation**‚Üí**Task**‚Üí**Action**‚Üí**Result**. Metrics. **key phrases**. 5-7 sentences. Natural.';
        else if(qType==='coding')sp='Expert coding coach.\nRESUME: '+this.resume.substring(0,1500)+'\nRULES: **Approach** (2 sent). Code. **Time O(?)** **Space O(?)**. **Edge cases**. Concise.';
        else sp='Expert interview coach. LIVE interview.\nRESUME:\n'+this.resume.substring(0,2500)+'\nJOB:\n'+this.jobDesc.substring(0,1000)+'\nHISTORY:\n'+hist+'\nRULES: First person. 3-5 sent simple, 5-7 complex. Metrics. **key phrases**. Natural. End with impact.';
        const answer=await this.callAI(sp+'\n\nQuestion: '+question+'\n\nAnswer:');
        this.conversationHistory.push('A: '+answer);return answer;
    },

    classifyQuestion(t){
        t=t.toLowerCase();
        if(['tell me about a time','describe a situation','give me an example','how did you handle','challenge','conflict','failure','leadership','teamwork','disagree'].some(w=>t.includes(w)))return'behavioral';
        if(['algorithm','array','string','tree','sort','search','code','implement','data structure','complexity','optimize','linked list','hash map','stack','queue'].some(w=>t.includes(w)))return'coding';
        if(['design a system','architecture','scale','millions of users','system design'].some(w=>t.includes(w)))return'system design';
        return'general';
    },

    // ===== DISPLAY =====
    displayAnswer(a){
        const el=document.getElementById('answerText');
        el.innerHTML=a.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/```(\w*)\n?([\s\S]*?)```/g,'<pre style="background:#0a0a2a;padding:10px;border-radius:6px;font-size:13px;overflow-x:auto;margin:6px 0;border:1px solid #1a1a3e"><code>$2</code></pre>').replace(/`([^`]+)`/g,'<code style="background:#0a0a2a;padding:2px 6px;border-radius:3px;font-size:14px;color:#ffd700">$1</code>').replace(/\n/g,'<br>');
        el.style.fontSize=this.fontSize+'px';
    },

    setStatus(s,t){const el=document.getElementById('statusBadge');el.className='sb '+s;el.textContent=t},
    changeFontSize(d){this.fontSize=Math.max(12,Math.min(36,this.fontSize+d));document.getElementById('answerText').style.fontSize=this.fontSize+'px';localStorage.setItem('nh_fontSize',this.fontSize)},
    clearDisplay(){document.getElementById('questionText').textContent='Listening...';document.getElementById('questionType').textContent='';document.getElementById('answerText').innerHTML='Ready.';this.setStatus('listening','‚óè LISTENING')},

    manualInput(){const q=prompt('Type the interview question:');if(q&&q.trim().length>3)this.processManual(q.trim())},

    async processManual(question){
        const st=Date.now();
        try{
            const qt=this.classifyQuestion(question);
            document.getElementById('questionText').textContent=question;
            document.getElementById('questionType').textContent=qt;
            document.getElementById('answerText').innerHTML='<span class="ld">‚è≥ Generating</span>';
            this.setStatus('thinking','‚óè THINKING');
            const answer=await this.generateAnswer(question,qt);
            this.questionCount++;this.displayAnswer(answer);
            document.getElementById('statQuestions').textContent=this.questionCount;
            document.getElementById('statSpeed').textContent=((Date.now()-st)/1000).toFixed(1)+'s';
            this.setStatus('ready','‚óè READY');
            if(this.vibrationEnabled&&navigator.vibrate)navigator.vibrate([100,50,100]);
            if(this.voiceEnabled)this.speakAnswer(answer);
        }catch(e){document.getElementById('answerText').textContent='‚ùå '+e.message;this.setStatus('error','‚óè ERROR')}
    },

    // ===== VOICE =====
    toggleVoice(){
        this.voiceEnabled=!this.voiceEnabled;localStorage.setItem('nh_voice',this.voiceEnabled);
        const b=document.getElementById('voiceToggle');
        b.textContent=this.voiceEnabled?'üîä ON':'üîá OFF';b.className='vt '+(this.voiceEnabled?'on':'off');
        if(!this.voiceEnabled)speechSynthesis.cancel();
    },
    adjustSpeed(d){this.voiceSpeed=Math.max(0.5,Math.min(2.5,this.voiceSpeed+d));document.getElementById('speedDisplay').textContent=this.voiceSpeed.toFixed(1)+'x';localStorage.setItem('nh_voiceSpeed',this.voiceSpeed)},
    speakAnswer(t){
        if(!this.voiceEnabled||!('speechSynthesis' in window))return;speechSynthesis.cancel();
        const c=t.replace(/\*\*/g,'').replace(/```[\s\S]*?```/g,'').replace(/`[^`]+`/g,'').replace(/#{1,3}\s/g,'').replace(/\n{2,}/g,'. ').replace(/\n/g,' ').trim();
        if(!c)return;const u=new SpeechSynthesisUtterance(c);u.rate=this.voiceSpeed;u.pitch=1;u.lang='en-US';speechSynthesis.speak(u);
    },

    // ===== PRACTICE =====
    selectCompany(c,b){this.selectedCompany=c;document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));b.classList.add('active')},

    nextPracticeQuestion(){
        const qs=this.questionBank[this.selectedCompany]||this.questionBank.general;
        this.currentPracticeQ=qs[Math.floor(Math.random()*qs.length)];
        document.getElementById('practiceQuestion').textContent=this.currentPracticeQ;
        document.getElementById('practiceAnswer').value='';
        document.getElementById('practiceFeedback').classList.add('hidden');
    },

    async evaluatePracticeAnswer(){
        const a=document.getElementById('practiceAnswer').value.trim();
        if(!a){alert('Write answer first!');return}
        const fb=document.getElementById('practiceFeedback');fb.classList.remove('hidden');fb.innerHTML='<span class="ld">ü§ñ Evaluating</span>';
        try{
            const r=await this.callAI('Interview coach.\nResume: '+this.resume.substring(0,1500)+'\n\n1. **Score**: X/10\n2. **Strengths**: 2 points\n3. **Improvements**: 2 points\n4. **Better Answer**: 4-5 sentences\n\nQuestion: '+this.currentPracticeQ+'\nAnswer: '+a);
            fb.innerHTML=r.replace(/\*\*(.*?)\*\*/g,'<b style="color:var(--p)">$1</b>');
        }catch(e){fb.textContent='‚ùå '+e.message}
    },

    async showIdealAnswer(){
        if(!this.currentPracticeQ){alert('Get question first!');return}
        const fb=document.getElementById('practiceFeedback');fb.classList.remove('hidden');fb.innerHTML='<span class="ld">üí° Generating</span>';
        try{
            const r=await this.callAI('Expert coach.\nResume: '+this.resume.substring(0,2000)+'\nJob: '+this.jobDesc.substring(0,800)+'\nPERFECT answer. First person. Metrics. **key phrases**. STAR for behavioral. 4-6 sentences.\n\nQuestion: '+this.currentPracticeQ);
            fb.innerHTML='<div style="color:var(--p);font-weight:700;margin-bottom:8px;font-size:12px">üí° IDEAL ANSWER</div>'+r.replace(/\*\*(.*?)\*\*/g,'<b style="color:var(--p)">$1</b>');
        }catch(e){fb.textContent='‚ùå '+e.message}
    },

    async generatePrepSheet(){
        const c=document.getElementById('prepCompany').value.trim(),ro=document.getElementById('prepRole').value.trim();
        if(!c){alert('Enter company name');return}
        const re=document.getElementById('prepResult');re.classList.remove('hidden');re.innerHTML='<span class="ld">üìã Generating (10-15s)</span>';
        try{
            const r=await this.callAI('Prep sheet.\nCOMPANY: '+c+'\nROLE: '+(ro||'Software Engineer')+'\nRESUME: '+this.resume.substring(0,2000)+'\n\n1. **Company Overview**\n2. **Top 8 Questions** with answers\n3. **Technical Topics**\n4. **3 Questions to ASK**\n5. **Avoid**\n6. **Power Phrases**\n7. **Elevator Pitch**\nUse resume.');
            re.innerHTML=r.replace(/\*\*(.*?)\*\*/g,'<b style="color:var(--p)">$1</b>').replace(/#{1,3}\s(.*?)(\n|$)/g,'<div style="color:var(--d);font-weight:700;margin-top:12px;font-size:15px">$1</div>').replace(/\n/g,'<br>');
        }catch(e){re.textContent='‚ùå '+e.message}
    },

    // ===== SETTINGS =====
    saveSettings(){
        this.keys.gemini=document.getElementById('settingsGeminiKey').value.trim();
        this.keys.groq=document.getElementById('settingsGroqKey').value.trim();
        this.keys.openrouter=document.getElementById('settingsORKey').value.trim();
        this.resume=document.getElementById('settingsResume').value.trim();
        this.jobDesc=document.getElementById('settingsJobDesc').value.trim();
        localStorage.setItem('nh_key_gemini',this.keys.gemini);localStorage.setItem('nh_key_groq',this.keys.groq);
        localStorage.setItem('nh_key_openrouter',this.keys.openrouter);
        localStorage.setItem('nh_resume',this.resume);localStorage.setItem('nh_jobDesc',this.jobDesc);
        this.updateKeyStatus();this.showToast('‚úÖ Saved!');
    },

    async testAllKeys(){
        let res=[];
        if(this.keys.gemini){try{const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models?key='+this.keys.gemini);res.push('Gemini: '+(r.ok?'‚úÖ':'‚ùå '+r.status))}catch(e){res.push('Gemini: ‚ùå')}}
        if(this.keys.groq){try{const r=await fetch('https://api.groq.com/openai/v1/models',{headers:{'Authorization':'Bearer '+this.keys.groq}});res.push('Groq: '+(r.ok?'‚úÖ':'‚ùå '+r.status))}catch(e){res.push('Groq: ‚ùå')}}
        if(this.keys.openrouter){try{const r=await fetch('https://openrouter.ai/api/v1/models',{headers:{'Authorization':'Bearer '+this.keys.openrouter}});res.push('OpenRouter: '+(r.ok?'‚úÖ':'‚ùå '+r.status))}catch(e){res.push('OpenRouter: ‚ùå')}}
        if(!res.length)res.push('No keys configured');
        alert('API Key Test:\n\n'+res.join('\n'));
    },

    toggleSetting(n,b){
        const on=b.classList.toggle('on');
        if(n==='voice'){this.voiceEnabled=on;localStorage.setItem('nh_voice',on)}
        else if(n==='vibration'){this.vibrationEnabled=on;localStorage.setItem('nh_vibration',on)}
        else if(n==='wake'){if(on)this.requestWakeLock()}
    },

    exportData(){
        const d={resume:this.resume,jobDesc:this.jobDesc,history:this.conversationHistory,questions:this.questionCount};
        const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);
        const a=document.createElement('a');a.href=u;a.download='neuralhire_export.json';a.click();URL.revokeObjectURL(u);
        this.showToast('üì§ Exported!');
    },

    clearAllData(){if(confirm('Delete ALL data?')){localStorage.clear();location.reload()}},
    setupTimer(){setInterval(()=>{if(!this.sessionStart)return;const e=Math.floor((Date.now()-this.sessionStart)/1000);document.getElementById('statSession').textContent=Math.floor(e/60)+':'+(e%60).toString().padStart(2,'0')},1000)},
    async requestWakeLock(){try{if('wakeLock' in navigator)await navigator.wakeLock.request('screen')}catch(e){}},
    showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
};

document.addEventListener('DOMContentLoaded',()=>NH.init());
document.addEventListener('visibilitychange',()=>{if(!document.hidden)NH.requestWakeLock()});
if('speechSynthesis' in window)speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();
</script>
</body>
</html>